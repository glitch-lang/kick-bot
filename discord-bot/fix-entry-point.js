/**
 * Fix Discord Activity Entry Point Command
 * 
 * This script creates the missing primary entry point command that Discord
 * needs to launch your Activity from the voice channel UI.
 * 
 * Based on: https://discord.com/developers/docs/activities/development-guides/user-actions
 */

require('dotenv').config();
const { REST, Routes } = require('discord.js');

const clientId = process.env.DISCORD_CLIENT_ID;
const token = process.env.DISCORD_BOT_TOKEN;

if (!clientId || !token) {
  console.error('âŒ Error: Missing DISCORD_CLIENT_ID or DISCORD_BOT_TOKEN in .env');
  process.exit(1);
}

const rest = new REST({ version: '10' }).setToken(token);

async function fixEntryPoint() {
  try {
    console.log('ðŸ” Checking for existing commands...');
    
    // Get existing global commands
    const commands = await rest.get(Routes.applicationCommands(clientId));
    
    console.log(`ðŸ“‹ Found ${commands.length} existing commands:`);
    commands.forEach(cmd => {
      console.log(`   - ${cmd.name} (type: ${cmd.type || 1}, handler: ${cmd.handler || 'none'})`);
    });
    
    // Check if primary entry point exists (type 4)
    const entryPoint = commands.find(cmd => cmd.type === 4);
    
    if (entryPoint) {
      console.log('\nâœ… Primary entry point command found!');
      
      // Check if it has the correct handler
      if (entryPoint.handler === 2) {
        console.log('   âœ… Handler is set correctly (DiscordLaunchActivity)');
        console.log('   Your Activity should be launchable now.');
        return;
      } else {
        console.log(`   âš ï¸  Handler is missing or incorrect (current: ${entryPoint.handler || 'none'})`);
        console.log('   ðŸ”§ Updating command with correct handler...');
        
        // Update the command
        await rest.patch(Routes.applicationCommand(clientId, entryPoint.id), {
          body: {
            handler: 2, // DiscordLaunchActivity
          }
        });
        
        console.log('   âœ… Command updated successfully!');
        console.log('   Your Activity should now be launchable!');
        return;
      }
    }
    
    console.log('\nâš ï¸  Primary entry point command missing!');
    console.log('ðŸ”§ Creating entry point command...');
    
    // Create the primary entry point command
    // Note: Discord may automatically create this when Activities is enabled
    // This is a fallback in case it didn't
    const entryPointCommand = {
      name: 'Launch Activity',
      type: 4, // PRIMARY_ENTRY_POINT
      handler: 2, // DiscordLaunchActivity - Discord handles launching the Activity
      description: 'Launch the Kick Watch Party activity',
      integration_types: [0, 1], // GUILD_INSTALL and USER_INSTALL
      contexts: [0, 1, 2], // GUILD, BOT_DM, PRIVATE_CHANNEL
    };
    
    // Try to register the command
    try {
      await rest.post(Routes.applicationCommands(clientId), {
        body: entryPointCommand
      });
      console.log('âœ… Entry point command created successfully!');
    } catch (error) {
      if (error.code === 50035) {
        console.log('âš ï¸  Cannot manually create entry point command.');
        console.log('   This command is auto-generated by Discord when Activities is enabled.');
        console.log('\nðŸ“‹ Make sure in Discord Developer Portal:');
        console.log('   1. Activities is enabled');
        console.log('   2. URL mappings are configured');
        console.log('   3. Save and wait 2-3 minutes for propagation');
      } else {
        throw error;
      }
    }
    
  } catch (error) {
    console.error('\nâŒ Error:', error.message);
    if (error.rawError) {
      console.error('Details:', JSON.stringify(error.rawError, null, 2));
    }
    process.exit(1);
  }
}

console.log('ðŸŽ® Discord Activity Entry Point Fix');
console.log('=====================================\n');
console.log(`Client ID: ${clientId}`);
console.log(`Bot Token: ${token.substring(0, 20)}...`);
console.log('');

fixEntryPoint().then(() => {
  console.log('\nâœ… Done! Try launching your Activity again.');
  process.exit(0);
});
